<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; 
                 script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; 
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
                 font-src https://fonts.gstatic.com; 
                 img-src 'self' https://*.googleusercontent.com https: data:; 
                 connect-src 'self' https://discord.com;">
  
  <link rel="icon" href="/icon.png" type="image/png">

  <meta property="og:title" content="SESE SERVER | 公式サイト" />
  <meta property="og:description" content="オーナー sese_PAP_1122 & MRF_4922 が統括する、規約に守られたクリーンなDiscordサーバーです。" />
  <meta property="og:type" content="website">
  <meta property="og:image" content="/icon.png">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:image" content="/icon.png">

  <title>SESE SERVER | 公式サイト</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'media',
      theme: { extend: { fontFamily: { sans: ['Noto Sans JP', 'sans-serif'] } } }
    }
  </script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    body { background-color: #fcfcfc; }
    @media (prefers-color-scheme: dark) {
      body { background-color: #0f172a; }
    }
    .glass {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    @media (prefers-color-scheme: dark) {
      .glass {
        background: rgba(30, 41, 59, 0.7);
      }
    }
    /* スムーズなフェードイン */
    .fade-in { animation: fadeIn 0.8s ease-out forwards; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="text-slate-900 dark:text-slate-100 font-sans selection:bg-indigo-100 dark:selection:bg-indigo-900/40">

  <nav class="fixed top-0 w-full z-50 glass border-b border-gray-100 dark:border-slate-800">
    <div class="max-w-5xl mx-auto px-6 h-16 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/20">
          <span class="text-white font-black text-xs">S</span>
        </div>
        <span class="font-black text-lg tracking-tighter">SESE SERVER</span>
      </div>
      <div id="user-nav" class="flex items-center gap-4 text-xs font-bold">
        </div>
    </div>
  </nav>

  <header class="pt-32 pb-20 px-6 text-center fade-in">
    <h1 class="text-5xl md:text-7xl font-black tracking-tight mb-6 bg-gradient-to-br from-slate-900 to-slate-500 dark:from-white dark:to-slate-400 bg-clip-text text-transparent">
      Next Gen Community.
    </h1>
    <p class="max-w-2xl mx-auto text-slate-500 dark:text-slate-400 font-bold leading-relaxed mb-10">
      sese_PAP_1122 & MRF_4922 が贈る、最高にクリーンで熱狂的なDiscordコミュニティ。
    </p>
    <div class="flex flex-wrap justify-center gap-4">
      <a href="https://discord.gg/your-invite" target="_blank" class="px-8 py-4 bg-indigo-600 text-white rounded-full font-black shadow-xl shadow-indigo-600/20 hover:scale-105 transition active:scale-95">Discordに参加</a>
      <a href="#contact" class="px-8 py-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-full font-black hover:bg-gray-50 dark:hover:bg-slate-700 transition">お問い合わせ</a>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-6 space-y-32 pb-32">
    
    <section id="contact" class="fade-in" style="animation-delay: 0.2s;">
      <div class="text-center mb-12">
        <h2 class="text-3xl font-black mb-2">Contact & Support</h2>
        <p class="text-sm text-gray-400 font-bold uppercase tracking-widest">運営への直接メッセージ</p>
      </div>

      <div id="contact-area" class="glass rounded-[40px] border border-gray-100 dark:border-slate-800 p-8 shadow-2xl shadow-slate-200/50 dark:shadow-none">
        <div id="login-required" class="text-center py-10 hidden">
          <p class="font-bold text-gray-500 dark:text-gray-400 mb-6 text-sm">お問い合わせを送信するにはGoogleログインが必要です</p>
          <a href="/auth/google" class="inline-flex items-center gap-3 px-8 py-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-2xl font-black transition hover:opacity-90">
            Googleでログイン
          </a>
        </div>

        <div id="contact-form-container" class="hidden space-y-6">
          <div class="flex items-center gap-4 p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-3xl">
            <img id="user-avatar" class="w-12 h-12 rounded-2xl border-2 border-white dark:border-slate-700" src="" alt="Avatar">
            <div>
              <p id="user-name-display" class="font-black text-sm"></p>
              <p id="user-email-display" class="text-[10px] text-indigo-600 dark:text-indigo-400 font-bold"></p>
            </div>
          </div>
          <textarea id="contact-content" rows="4" class="w-full bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-3xl p-6 text-sm font-bold focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition" placeholder="質問や提案を入力してください..."></textarea>
          <button id="send-contact" class="w-full py-4 bg-indigo-600 text-white rounded-3xl font-black shadow-lg shadow-indigo-600/20 hover:bg-indigo-700 transition">メッセージを送信</button>
          
          <div class="mt-12">
            <h3 class="font-black text-lg mb-6 flex items-center gap-2">
              <span class="w-2 h-6 bg-indigo-600 rounded-full"></span> 過去のお問い合わせ
            </h3>
            <div id="my-messages" class="space-y-4">
              </div>
          </div>
        </div>
      </div>
    </section>

    <section id="admin-panel" class="hidden fade-in">
      <div class="text-center mb-12">
        <h2 class="text-3xl font-black mb-2 text-indigo-600">Admin Dashboard</h2>
        <p class="text-sm text-gray-400 font-bold uppercase tracking-widest">メッセージ管理</p>
      </div>
      <div id="admin-message-list" class="space-y-4">
        </div>
    </section>

  </main>

  <dialog id="admin-reply-modal" class="rounded-3xl p-0 glass border border-gray-100 dark:border-slate-800 backdrop:backdrop-blur-sm w-full max-w-lg overflow-hidden">
    <div class="p-8">
      <h3 class="font-black text-xl mb-4">回答を入力</h3>
      <textarea id="reply-textarea" class="w-full h-40 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-2xl p-4 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500" placeholder="返信内容..."></textarea>
      <div class="flex justify-end gap-3 mt-6">
        <button id="modal-cancel" class="px-6 py-2 text-sm font-bold text-gray-500">キャンセル</button>
        <button id="modal-send" class="px-8 py-2 bg-indigo-600 text-white rounded-full text-sm font-black shadow-lg shadow-indigo-600/20">回答を送信</button>
      </div>
    </div>
  </dialog>

  <footer class="py-10 border-t border-gray-100 dark:border-slate-800 text-center">
    <p class="text-[10px] text-gray-400 font-black uppercase tracking-[0.2em]">&copy; 2024 SESE SERVER. All Rights Reserved.</p>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      
      const escapeHTML = (str) => {
        if(!str) return "";
        return DOMPurify.sanitize(str);
      };

      // ユーザー状態チェック
      async function checkAuth() {
        try {
          const res = await fetch('/api/user');
          const data = await res.json();
          
          const nav = document.getElementById('user-nav');
          const contactArea = document.getElementById('contact-area');
          const loginReq = document.getElementById('login-required');
          const formCont = document.getElementById('contact-form-container');

          if (data.loggedIn) {
            nav.innerHTML = `
              <span class="text-gray-400">${escapeHTML(data.user.displayName)}</span>
              <a href="/logout" class="text-slate-900 dark:text-white border-b-2 border-indigo-600">Logout</a>
            `;
            loginReq.classList.add('hidden');
            formCont.classList.remove('hidden');
            document.getElementById('user-avatar').src = data.user.photos[0].value;
            document.getElementById('user-name-display').innerText = data.user.displayName;
            document.getElementById('user-email-display').innerText = data.user.emails[0].value;

            loadMyMessages();

            if (data.isAdmin) {
              document.getElementById('admin-panel').classList.remove('hidden');
              loadAdminMessages();
            }
          } else {
            nav.innerHTML = `<a href="/auth/google" class="bg-indigo-600 text-white px-5 py-2 rounded-full shadow-lg shadow-indigo-500/20 hover:bg-indigo-700 transition">Admin Login</a>`;
            loginReq.classList.remove('hidden');
            formCont.classList.add('hidden');
          }
        } catch (e) { console.error(e); }
      }

      checkAuth();

      // お問い合わせ送信
      document.getElementById('send-contact').addEventListener('click', async () => {
        const content = document.getElementById('contact-content').value;
        if (!content) return alert('内容を入力してください');

        try {
          const res = await fetch('/api/contact', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
          });
          const result = await res.json();
          if (result.success) {
            alert('送信しました');
            document.getElementById('contact-content').value = '';
            loadMyMessages();
          }
        } catch (e) { alert('送信失敗'); }
      });

      // 自分の履歴読み込み
      async function loadMyMessages() {
        const list = document.getElementById('my-messages');
        try {
          const res = await fetch('/api/my-messages');
          const data = await res.json();
          if (!data.messages || data.messages.length === 0) {
            list.innerHTML = '<p class="text-xs text-gray-400 font-bold">まだメッセージはありません。</p>';
            return;
          }
          list.innerHTML = data.messages.map(m => `
            <div class="p-5 bg-white dark:bg-slate-900 border border-gray-100 dark:border-slate-800 rounded-3xl shadow-sm">
              <p class="text-[10px] text-gray-400 font-black mb-2">${escapeHTML(m.timestamp)}</p>
              <p class="text-xs font-bold text-gray-600 dark:text-slate-300 mb-4">${escapeHTML(m.content)}</p>
              ${m.reply ? `
                <div class="p-4 bg-indigo-50 dark:bg-indigo-900/30 rounded-2xl">
                  <p class="text-[10px] text-indigo-600 font-black uppercase mb-1">Answer</p>
                  <p class="text-xs font-bold">${escapeHTML(m.reply)}</p>
                </div>
              ` : `
                <div class="text-[10px] text-gray-300 font-black uppercase">回答待ち...</div>
              `}
            </div>
          `).reverse().join('');
        } catch (e) { console.error(e); }
      }

      // 管理者：全メッセージ読み込み
      async function loadAdminMessages() {
        const list = document.getElementById('admin-message-list');
        try {
          const res = await fetch('/api/admin/messages');
          if (res.status === 403) { list.innerHTML = '<p class="text-red-500 font-bold">権限がありません</p>'; return; }
          
          const data = await res.json();
          if(!data.messages || data.messages.length === 0) {
            list.innerHTML = '<p class="text-center text-gray-400 py-10 font-bold">メッセージはまだありません。</p>';
            return;
          }
          
          list.innerHTML = data.messages.map(m => `
            <div class="p-6 bg-gray-50 dark:bg-slate-900/50 rounded-3xl border border-gray-100 dark:border-slate-700 mb-4">
              <div class="flex justify-between items-start mb-2">
                <span class="font-black text-indigo-600 text-xs">${escapeHTML(m.userName)} (${escapeHTML(m.email)})</span>
                <span class="text-[9px] text-gray-400 font-bold">${escapeHTML(m.timestamp)}</span>
              </div>
              <p class="text-sm font-bold text-gray-700 dark:text-slate-300 mb-4 break-words">${escapeHTML(m.content)}</p>
              ${m.reply ? `<div class="p-2 bg-green-100 dark:bg-green-900/30 rounded text-xs text-green-700 dark:text-green-300 font-bold mb-4">回答済み: ${escapeHTML(m.reply)}</div>` : ''}
              
              <div class="flex gap-2 mt-4">
                <button data-msg-id="${escapeHTML(m.id || m._id)}" class="reply-btn text-[10px] font-black bg-indigo-600 text-white px-5 py-2 rounded-full hover:bg-indigo-700 transition">回答する</button>
                <button data-msg-id="${escapeHTML(m.id || m._id)}" class="delete-btn text-[10px] font-black bg-red-500 text-white px-5 py-2 rounded-full hover:bg-red-600 transition">終了・削除</button>
              </div>
            </div>
          `).reverse().join('');

          // イベント登録（回答）
          document.querySelectorAll('.reply-btn').forEach(btn => {
            btn.addEventListener('click', () => openReplyModal(btn.dataset.msgId));
          });

          // イベント登録（削除）
          document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => deleteMessage(btn.dataset.msgId));
          });

        } catch (e) { list.innerHTML = '読み込み失敗'; }
      }

      // 管理者：メッセージ削除処理
      async function deleteMessage(id) {
        if (!confirm('本当にこの質問を終了してデータを削除しますか？\nこの操作は取り消せません。')) {
          return;
        }

        try {
          const res = await fetch(`/api/admin/messages/${id}`, {
            method: 'DELETE'
          });
          const result = await res.json();
          
          if (result.success) {
            alert('削除しました');
            loadAdminMessages(); 
          } else {
            alert('エラー: ' + result.error);
          }
        } catch (err) {
          console.error(err);
          alert('通信エラーが発生しました');
        }
      }

      // 管理者モーダル
      const modal = document.getElementById('admin-reply-modal');
      const replyText = document.getElementById('reply-textarea');
      let currentReplyId = null;

      function openReplyModal(id) {
        currentReplyId = id;
        replyText.value = '';
        modal.showModal();
      }

      document.getElementById('modal-cancel').addEventListener('click', () => {
        modal.close();
        currentReplyId = null;
      });

      document.getElementById('modal-send').addEventListener('click', async () => {
        if(!currentReplyId || !replyText.value) return;
        
        try {
          const res = await fetch('/api/admin/reply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ messageId: currentReplyId, replyContent: replyText.value } )
          });
          const result = await res.json();
          if(result.success) {
             modal.close();
             loadAdminMessages(); 
          } else {
            alert('送信失敗: ' + (result.error || '不明なエラー'));
          }
        } catch (e) { alert('通信エラー'); }
      });

    });
  </script>
</body>
</html>
